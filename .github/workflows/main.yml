name: Main

on:
    push:
        branches:
            - main
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]

jobs:
    quality:
        runs-on: ubuntu-latest
        steps:
            - name: Check out
              uses: actions/checkout@v4

            - uses: actions/cache@v4
              with:
                  path: ~/.cache/pre-commit
                  key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

            - name: Set up the environment
              uses: ./.github/actions/setup-uv-env
              with:
                  groups: dev

            - name: Run checks
              run: make check

    tests-core:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.11", "3.12"]
            fail-fast: false
        defaults:
            run:
                shell: bash
        steps:
            - name: Check out
              uses: actions/checkout@v4

            - name: Set up the environment
              uses: ./.github/actions/setup-uv-env
              with:
                  python-version: ${{ matrix.python-version }}
                  groups: dev

            - name: Run tests
              run: uv run pytest tests -m "not ase and not pysis and not train" --cov --cov-config=pyproject.toml --cov-report=xml

            - name: Upload coverage reports to Codecov with GitHub Action on Python 3.11
              uses: codecov/codecov-action@v4
              if: ${{ matrix.python-version == '3.11' }}

    tests-ase:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.11"]
            fail-fast: false
        defaults:
            run:
                shell: bash
        steps:
            - name: Check out
              uses: actions/checkout@v4

            - name: Set up the environment
              uses: ./.github/actions/setup-uv-env
              with:
                  python-version: ${{ matrix.python-version }}
                  groups: dev
                  extras: ase

            - name: Run ASE tests
              run: uv run pytest tests -m ase

    tests-train:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.11"]
            fail-fast: false
        defaults:
            run:
                shell: bash
        steps:
            - name: Check out
              uses: actions/checkout@v4

            - name: Set up the environment
              uses: ./.github/actions/setup-uv-env
              with:
                  python-version: ${{ matrix.python-version }}
                  groups: dev
                  extras: train

            - name: Run train-marked tests (allow empty)
              run: |
                  set -e
                  uv run pytest tests -m train || rc=$?
                  if [ "${rc:-0}" -eq 5 ]; then
                    echo "No train-marked tests collected; treating as success."
                    exit 0
                  fi
                  exit "${rc:-0}"

    tests-pysis:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.11"]
            fail-fast: false
        defaults:
            run:
                shell: bash
        steps:
            - name: Check out
              uses: actions/checkout@v4

            - name: Set up the environment
              uses: ./.github/actions/setup-uv-env
              with:
                  python-version: ${{ matrix.python-version }}
                  groups: dev
                  extras: pysis

            - name: Run pysis-marked tests (allow empty)
              run: |
                  set -e
                  uv run pytest tests -m pysis || rc=$?
                  if [ "${rc:-0}" -eq 5 ]; then
                    echo "No pysis-marked tests collected; treating as success."
                    exit 0
                  fi
                  exit "${rc:-0}"

    check-docs:
        runs-on: ubuntu-latest
        steps:
            - name: Check out
              uses: actions/checkout@v4

            - name: Set up the environment
              uses: ./.github/actions/setup-uv-env
              with:
                  groups: docs

            - name: Check if documentation can be built
              run: uv run mkdocs build -s
